
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AZORG â€” Woonâ€‘werkverkeer calculator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1, h2 { margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    .field { margin-bottom: 12px; }
    input[type="password"], input[type="text"] {
      width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 6px;
    }
    button.primary {
      padding: 10px 16px; border: none; border-radius: 6px; background: #0058b0; color: #fff; cursor: pointer;
    }
    button.primary:disabled { background: #9bb8db; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #e6e6e6; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #f7f8fa; }
    .muted { color: #666; font-size: 0.95em; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .note { background: #fff8e1; border: 1px solid #ffe082; padding: 10px; border-radius: 6px; margin-top: 8px; }
    .error { background: #fdecea; border: 1px solid #f5c6cb; color: #7f1d1d; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>AZORG â€” Woonâ€‘werkverkeer calculator</h1>
    <p class="muted">Bereken afstand, tijd en vergoeding (auto & fiets) vanuit jouw vertrekadres naar 6 campussen.</p>
  </header>

  <section class="card">
    <div class="field">
      <label for="apiKey">OpenRouteService APIâ€‘key</label>
      <input id="apiKey" type="password"
             value="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImY0YTA5MTgyZWRjODRiNTZhMzI5ZWY3ZDJiZTNhYTQ3IiwiaCI6Im11cm11cjY0In0=" />
    </div>
    <div class="field">
      <label for="origin">Je vertrekadres</label>
      <input id="origin" type="text" placeholder="bv. Stationsstraat 1, 9300 Aalst" />
    </div>
    <div style="margin-top:12px;">
      <button id="btnGeocodeOrigin" class="primary">Geocodeer vertrekadres</button>
      <button id="btnCalculate" class="primary" disabled>Bereken</button>
    </div>
    <p class="note">
      ðŸ’¡ Vul eerst je vertrekadres in. Klik vervolgens op <strong>Geocodeer vertrekadres</strong>. Als de geocodering lukt, kun je op <strong>Bereken</strong> klikken.
    </p>
  </section>

  <section class="card">
    <h2>Tarieven woonâ€‘werkvergoeding</h2>
  <p class="muted">De dagvergoeding wordt bepaald op basis van de afstand (km, enkel traject) volgens de tabel "Sociaal abonnement" uit het meegeleverde Excel-bestand.</p>
</section>

  <section class="card">
    <table id="results">
      <thead>
        <tr>
          <th>#</th>
          <th>Adres (Campus)</th>
          <th>Auto â€” afstand / tijd</th>
          <th>Fiets â€” afstand / tijd</th>
          <th>Vergoeding auto</th>
          <th>Vergoeding fiets</th>
      <th>Werkdagen</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="errors"></div>
  </section>

  
<script>
// Tarieftabel (per dag) uit 'sociaal abonnement.xlsx'
// Kolommen: [km_van, km_tot, bedrag_per_dag]
const SOCIAAL_TARIEVEN = [[0.0, 0.0, 0.0], [1.0, 1.0, 1.0136363636363637], [2.0, 2.0, 1.0136363636363637], [3.0, 3.0, 1.0136363636363637], [4.0, 4.0, 1.1090909090909091], [5.0, 5.0, 1.1818181818181819], [6.0, 6.0, 1.2727272727272727], [7.0, 7.0, 1.3636363636363635], [8.0, 8.0, 1.4090909090909092], [9.0, 9.0, 1.5], [10.0, 10.0, 1.5909090909090908], [11.0, 11.0, 1.6818181818181819], [12.0, 12.0, 1.75], [13.0, 13.0, 1.8181818181818181], [14.0, 14.0, 1.9090909090909092], [15.0, 15.0, 1.9772727272727273], [16.0, 16.0, 2.0454545454545454], [17.0, 17.0, 2.159090909090909], [18.0, 18.0, 2.227272727272727], [19.0, 19.0, 2.3181818181818183], [20.0, 20.0, 2.409090909090909], [21.0, 21.0, 2.4545454545454546], [22.0, 22.0, 2.5454545454545454], [23.0, 23.0, 2.6363636363636362], [24.0, 24.0, 2.6818181818181817], [25.0, 25.0, 2.8181818181818183], [26.0, 26.0, 2.8636363636363638], [27.0, 27.0, 2.9545454545454546], [28.0, 28.0, 3.0454545454545454], [29.0, 29.0, 3.090909090909091], [30.0, 30.0, 3.1818181818181817], [31.0, 33.0, 3.3181818181818183], [34.0, 36.0, 3.5454545454545454], [37.0, 39.0, 3.727272727272727], [40.0, 42.0, 3.9545454545454546], [43.0, 45.0, 4.136363636363637], [46.0, 48.0, 4.363636363636363], [49.0, 51.0, 4.590909090909091], [52.0, 54.0, 4.7272727272727275], [55.0, 57.0, 4.863636363636363], [58.0, 60.0, 5.045454545454546], [61.0, 65.0, 5.2272727272727275], [66.0, 70.0, 5.454545454545454], [71.0, 75.0, 5.7272727272727275], [76.0, 80.0, 6.0], [81.0, 85.0, 6.2272727272727275], [86.0, 90.0, 6.5], [91.0, 95.0, 6.7272727272727275], [96.0, 100.0, 6.954545454545454], [101.0, 105.0, 7.2727272727272725], [106.0, 110.0, 7.5], [111.0, 115.0, 7.7727272727272725], [116.0, 120.0, 8.045454545454545], [121.0, 125.0, 8.227272727272727], [126.0, 130.0, 8.5], [131.0, 135.0, 8.727272727272727], [136.0, 140.0, 9.0], [141.0, 145.0, 9.227272727272727], [146.0, 150.0, 9.590909090909092], [151.0, 155.0, 9.727272727272727], [156.0, 160.0, 10.0], [161.0, 165.0, 10.227272727272727], [166.0, 170.0, 10.5], [171.0, 175.0, 10.727272727272727], [176.0, 180.0, 11.0], [181.0, 185.0, 11.181818181818182], [186.0, 190.0, 11.5], [191.0, 195.0, 11.727272727272727], [196.0, 999.0, 12.0]];

const campussen = [
  { adres: 'Moorselbaan 164, 9300 Aalst' },
  { adres: 'Merestraat 80, 9300 Aalst' },
  { adres: 'Bloklaan 5, 1730 Asse' },
  { adres: 'Gasthuisstraat 4, 9500 Geraardsbergen' },
  { adres: 'Biezenstraat 2, 9400 Ninove' },
  { adres: 'Wegvoeringstraat 73, 9230 Wetteren' }
];

const elApiKey = document.getElementById('apiKey');
const elOrigin = document.getElementById('origin');
const elBtnGeo = document.getElementById('btnGeocodeOrigin');
const elBtnCalc = document.getElementById('btnCalculate');
const elTBody = document.querySelector('#results tbody');
const elErrors = document.getElementById('errors');

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, (s) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[s]));
}

function showError(msg) {
  const div = document.createElement('div');
  div.className = 'error';
  div.textContent = msg;
  elErrors.appendChild(div);
  setTimeout(() => div.remove(), 8000);
}

function euro(x) {
  if (!isFinite(x)) return 'â€”';
  return `â‚¬ ${x.toFixed(2).replace('.', ',')}`;
}

function formatKm(meters) { return (meters / 1000).toFixed(2); }

function formatTime(seconds) {
  const mins = Math.round(seconds / 60);
  if (mins < 60) return `${mins} min`;
  const h = Math.floor(mins / 60);
  const m = mins % 60;
  return `${h} u ${m} min`;
}

// Lookup dagvergoeding op basis van afstand (km, enkel traject)
// We ronden naar boven (ceil) zodat 4,01 km in de schijf 5 km valt (niet 4 km).
function dagvergoedingVoorKm(km) {
  const k = Math.max(0, Math.ceil(km));
  for (const [from, to, perDag] of SOCIAAL_TARIEVEN) {
    if (k >= from && k <= to) return perDag;
  }
  // fallback (zou niet moeten gebeuren door laatste 196-999)
  return 0;
}

function makeWerkdagenSelect(defaultVal = 22) {
  const sel = document.createElement('select');
  sel.className = 'werkdagenSelect';
  for (let i = 1; i <= 31; i++) {
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = String(i);
    if (i === defaultVal) opt.selected = true;
    sel.appendChild(opt);
  }
  return sel;
}

function updateRowVergoedingen(row) {
  const days = parseInt(row.querySelector('.werkdagenSelect')?.value || '22', 10);
  const autoPerDag = parseFloat(row.dataset.autoPerDag || '0');
  const fietsPerDag = parseFloat(row.dataset.fietsPerDag || '0');

  const tdAutoVer = row.querySelector('.autoVergoeding');
  const tdFietsVer = row.querySelector('.fietsVergoeding');

  if (tdAutoVer) tdAutoVer.textContent = `${euro(autoPerDag)}/dag â€” ${euro(autoPerDag * days)}`;
  if (tdFietsVer) tdFietsVer.textContent = `${euro(fietsPerDag)}/dag â€” ${euro(fietsPerDag * days)}`;
}

function renderInitialTable() {
  elTBody.innerHTML = '';
  campussen.forEach((c, idx) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td>${escapeHtml(c.adres)}</td>
      <td class="auto">â€”</td>
      <td class="fiets">â€”</td>
      <td class="autoVergoeding">â€”</td>
      <td class="fietsVergoeding">â€”</td>
      <td class="werkdagen"></td>
    `;

    const tdWerkdagen = tr.querySelector('.werkdagen');
    const sel = makeWerkdagenSelect(22);
    sel.addEventListener('change', () => updateRowVergoedingen(tr));
    tdWerkdagen.appendChild(sel);

    elTBody.appendChild(tr);
  });
}
renderInitialTable();

async function geocode(text, apiKey) {
  const url = 'https://api.openrouteservice.org/geocode/search';
  const params = new URLSearchParams({ text, size: '1', lang: 'nl' }).toString();
  const res = await fetch(`${url}?${params}`, {
    headers: { 'Authorization': apiKey }
  });
  if (!res.ok) throw new Error(`Geocoding mislukt (${res.status})`);
  const data = await res.json();
  const feat = data.features?.[0];
  if (!feat) throw new Error('Geen geocode-resultaat gevonden');
  const [lon, lat] = feat.geometry.coordinates;
  return { lat, lon };
}

async function route(origin, destination, profile, apiKey) {
  const url = `https://api.openrouteservice.org/v2/directions/${profile}`;
  const body = {
    coordinates: [
      [origin.lon, origin.lat],
      [destination.lon, destination.lat]
    ]
  };
  const res = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': apiKey,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(`Route mislukt (${profile}, ${res.status})`);
  const data = await res.json();
  const seg = data.routes?.[0]?.summary;
  if (!seg) throw new Error('Geen route-samenvatting ontvangen');
  return { meters: seg.distance, seconds: seg.duration };
}

elBtnGeo.addEventListener('click', async () => {
  elBtnGeo.disabled = true;
  elBtnCalc.disabled = true;
  try {
    const apiKey = (elApiKey.value || '').trim();
    const originText = (elOrigin.value || '').trim();
    if (!apiKey) throw new Error('Vul je OpenRouteService API-key in.');
    if (!originText) throw new Error('Vul je vertrekadres in.');
    window.__origin = await geocode(originText, apiKey);
    elBtnCalc.disabled = false;
  } catch (err) {
    showError(err.message || String(err));
  } finally {
    elBtnGeo.disabled = false;
  }
});

elBtnCalc.addEventListener('click', async () => {
  elBtnCalc.disabled = true;
  try {
    const apiKey = (elApiKey.value || '').trim();
    const origin = window.__origin;
    if (!origin) throw new Error('Geocodeer eerst je vertrekadres.');

    // Geocode campussen
    const dests = [];
    for (const c of campussen) {
      try {
        const geo = await geocode(c.adres, apiKey);
        dests.push({ ...c, geo });
      } catch (e) {
        dests.push({ ...c, geo: null, error: e.message });
      }
    }

    const rows = Array.from(elTBody.querySelectorAll('tr'));

    for (let i = 0; i < dests.length; i++) {
      const row = rows[i];
      const dest = dests[i];
      const tdAuto = row.querySelector('.auto');
      const tdFiets = row.querySelector('.fiets');

      // reset perDag
      row.dataset.autoPerDag = '0';
      row.dataset.fietsPerDag = '0';

      if (!dest.geo) {
        tdAuto.textContent = 'â€”';
        tdFiets.textContent = 'â€”';
        showError(`Geocoding mislukt voor: ${dest.adres} (${dest.error})`);
        updateRowVergoedingen(row);
        continue;
      }

      // Auto route
      try {
        const ra = await route(origin, dest.geo, 'driving-car', apiKey);
        const kmA = parseFloat(formatKm(ra.meters));
        tdAuto.textContent = `${kmA} km â€” ${formatTime(ra.seconds)}`;
        row.dataset.autoPerDag = String(dagvergoedingVoorKm(kmA));
      } catch (e) {
        tdAuto.textContent = 'â€”';
        showError(`Route (auto) mislukt voor: ${dest.adres} (${e.message})`);
      }

      // Fiets route
      try {
        const rf = await route(origin, dest.geo, 'cycling-regular', apiKey);
        const kmF = parseFloat(formatKm(rf.meters));
        tdFiets.textContent = `${kmF} km â€” ${formatTime(rf.seconds)}`;
        row.dataset.fietsPerDag = String(dagvergoedingVoorKm(kmF));
      } catch (e) {
        tdFiets.textContent = 'â€”';
        showError(`Route (fiets) mislukt voor: ${dest.adres} (${e.message})`);
      }

      updateRowVergoedingen(row);
    }

  } catch (err) {
    showError(err.message || String(err));
  } finally {
    elBtnCalc.disabled = false;
  }
});
</script>

</body>
</html>
