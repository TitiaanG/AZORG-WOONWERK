
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AZORG â€” Woonâ€‘werkverkeer calculator</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1, h2 { margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    label { display: block; font-weight: 600; margin-bottom: 6px; }
    .field { margin-bottom: 12px; }
    input[type="password"], input[type="text"] {
      width: 100%; padding: 10px; border: 1px solid #bbb; border-radius: 6px;
    }
    button.primary {
      padding: 10px 16px; border: none; border-radius: 6px; background: #0058b0; color: #fff; cursor: pointer;
    }
    button.primary:disabled { background: #9bb8db; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #e6e6e6; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #f7f8fa; }
    .muted { color: #666; font-size: 0.95em; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .note { background: #fff8e1; border: 1px solid #ffe082; padding: 10px; border-radius: 6px; margin-top: 8px; }
    .error { background: #fdecea; border: 1px solid #f5c6cb; color: #7f1d1d; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>AZORG â€” Woonâ€‘werkverkeer calculator</h1>
    <p class="muted">Bereken afstand, tijd en vergoeding (auto & fiets) vanuit jouw vertrekadres naar 6 campussen.</p>
  </header>

  <section class="card">
    <div class="field">
      <label for="apiKey">OpenRouteService APIâ€‘key</label>
      <input id="apiKey" type="password"
             value="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImY0YTA5MTgyZWRjODRiNTZhMzI5ZWY3ZDJiZTNhYTQ3IiwiaCI6Im11cm11cjY0In0=" />
    </div>
    <div class="field">
      <label for="origin">Je vertrekadres</label>
      <input id="origin" type="text" placeholder="bv. Stationsstraat 1, 9300 Aalst" />
    </div>
    <div style="margin-top:12px;">
      <button id="btnGeocodeOrigin" class="primary">Geocodeer vertrekadres</button>
      <button id="btnCalculate" class="primary" disabled>Bereken</button>
    </div>
    <p class="note">
      ðŸ’¡ Vul eerst je vertrekadres in. Klik vervolgens op <strong>Geocodeer vertrekadres</strong>. Als de geocodering lukt, kun je op <strong>Bereken</strong> klikken.
    </p>
  </section>

  <section class="card">
    <h2>Tarieven woonâ€‘werkvergoeding</h2>
    <ul>
      <li>Auto (vanaf 4 km, enkel heen): <span class="mono">â‚¬ 0,4449/km</span></li>
      <li>Fiets (alle km, heen + terug): <span class="mono">â‚¬ 0,3600/km</span></li>
    </ul>
  </section>

  <section class="card">
    <table id="results">
      <thead>
        <tr>
          <th>#</th>
          <th>Adres (Campus)</th>
          <th>Auto â€” afstand / tijd</th>
          <th>Fiets â€” afstand / tijd</th>
          <th>Vergoeding auto</th>
          <th>Vergoeding fiets (heen + terug)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="errors"></div>
  </section>

  <script>
    const AUTO_TARIEF = 0.4449;
    const FIETS_TARIEF = 0.3600;
    const MIN_AUTO_KM = 4.0;

    const campussen = [
      { adres: 'Moorselbaan 164, 9300 Aalst' },
      { adres: 'Merestraat 80, 9300 Aalst' },
      { adres: 'Bloklaan 5, 1730 Asse' },
      { adres: 'Gasthuisstraat 4, 9500 Geraardsbergen' },
      { adres: 'Biezenstraat 2, 9400 Ninove' },
      { adres: 'Wegvoeringstraat 73, 9230 Wetteren' }
    ];

    const elApiKey = document.getElementById('apiKey');
    const elOrigin = document.getElementById('origin');
    const elBtnGeo = document.getElementById('btnGeocodeOrigin');
    const elBtnCalc = document.getElementById('btnCalculate');
    const elTBody = document.querySelector('#results tbody');
    const elErrors = document.getElementById('errors');

    function renderInitialTable() {
      elTBody.innerHTML = '';
      campussen.forEach((c, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${escapeHtml(c.adres)}</td>
          <td class="auto">â€”</td>
          <td class="fiets">â€”</td>
          <td class="autoVergoeding">â€”</td>
          <td class="fietsVergoeding">â€”</td>
        `;
        elTBody.appendChild(tr);
      });
    }
    renderInitialTable();

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    function showError(msg) {
      const div = document.createElement('div');
      div.className = 'error';
      div.textContent = msg;
      elErrors.appendChild(div);
      setTimeout(() => div.remove(), 8000);
    }

    async function geocode(text, apiKey) {
      const url = 'https://api.openrouteservice.org/geocode/search';
      const params = new URLSearchParams({ text, size: '1', lang: 'nl' }).toString();
      const res = await fetch(`${url}?${params}`, {
        headers: { 'Authorization': apiKey }
      });
      if (!res.ok) throw new Error(`Geocoding mislukt (${res.status})`);
      const data = await res.json();
      const feat = data.features?.[0];
      if (!feat) throw new Error('Geen geocodeâ€‘resultaat gevonden');
      const [lon, lat] = feat.geometry.coordinates;
      return { lat, lon };
    }

    async function route(origin, destination, profile, apiKey) {
      const url = `https://api.openrouteservice.org/v2/directions/${profile}`;
      const body = {
        coordinates: [
          [origin.lon, origin.lat],
          [destination.lon, destination.lat]
        ]
      };
      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': apiKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(`Route mislukt (${profile}, ${res.status})`);
      const data = await res.json();
      const seg = data.routes?.[0]?.summary;
      if (!seg) throw new Error('Geen routeâ€‘samenvatting ontvangen');
      return { meters: seg.distance, seconds: seg.duration };
    }

    function formatKm(meters) { return (meters / 1000).toFixed(2); }
    function formatTime(seconds) {
      const mins = Math.round(seconds / 60);
      if (mins < 60) return `${mins} min`;
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return `${h} u ${m} min`;
    }
    function calcAutoVergoeding(km) { return km < MIN_AUTO_KM ? 0 : km * AUTO_TARIEF; }
    function calcFietsVergoeding(km) { return km * 2 * FIETS_TARIEF; }
    function euro(x) { return `â‚¬ ${x.toFixed(2).replace('.', ',')}`; }

    elBtnGeo.addEventListener('click', async () => {
      elBtnGeo.disabled = true;
      elBtnCalc.disabled = true;
      try {
        const apiKey = (elApiKey.value || '').trim();
        const originText = (elOrigin.value || '').trim();
        if (!apiKey) throw new Error('Vul je OpenRouteService APIâ€‘key in.');
        if (!originText) throw new Error('Vul je vertrekadres in.');
        window.__origin = await geocode(originText, apiKey);
        elBtnCalc.disabled = false;
      } catch (err) {
        showError(err.message || String(err));
      } finally {
        elBtnGeo.disabled = false;
      }
    });

    elBtnCalc.addEventListener('click', async () => {
      elBtnCalc.disabled = true;
      try {
        const apiKey = (elApiKey.value || '').trim();
        const origin = window.__origin;
        if (!origin) throw new Error('Geocodeer eerst je vertrekadres.');

        const dests = [];
        for (const c of campussen) {
          try {
            const geo = await geocode(c.adres, apiKey);
            dests.push({ ...c, geo });
          } catch (e) {
            dests.push({ ...c, geo: null, error: e.message });
          }
        }

        const rows = Array.from(elTBody.querySelectorAll('tr'));
        for (let i = 0; i < dests.length; i++) {
          const row = rows[i];
          const dest = dests[i];
          const tdAuto = row.querySelector('.auto');
          const tdFiets = row.querySelector('.fiets');
          const tdAutoVer = row.querySelector('.autoVergoeding');
          const tdFietsVer = row.querySelector('.fietsVergoeding');

          if (!dest.geo) {
            tdAuto.textContent = 'â€”';
            tdFiets.textContent = 'â€”';
            tdAutoVer.textContent = 'â€”';
            tdFietsVer.textContent = 'â€”';
            showError(`Geocoding mislukt voor: ${dest.adres} (${dest.error})`);
            continue;
          }

          try {
            const ra = await route(origin, dest.geo, 'driving-car', apiKey);
            const kmA = parseFloat(formatKm(ra.meters));
            tdAuto.textContent = `${kmA} km â€” ${formatTime(ra.seconds)}`;
            tdAutoVer.textContent = euro(calcAutoVergoeding(kmA));
          } catch (e) {
            tdAuto.textContent = 'â€”';
            tdAutoVer.textContent = 'â€”';
            showError(`Route (auto) mislukt voor: ${dest.adres} (${e.message})`);
          }

          try {
            const rf = await route(origin, dest.geo, 'cycling-regular', apiKey);
            const kmF = parseFloat(formatKm(rf.meters));
            tdFiets.textContent = `${kmF} km â€” ${formatTime(rf.seconds)}`;
            tdFietsVer.textContent = euro(calcFietsVergoeding(kmF));
          } catch (e) {
            tdFiets.textContent = 'â€”';
            tdFietsVer.textContent = 'â€”';
            showError(`Route (fiets) mislukt voor: ${dest.adres} (${e.message})`);
          }
        }
      } catch (err) {
        showError(err.message || String(err));
      } finally {
        elBtnCalc.disabled = false;
      }
    });
  </script>
</body>
</html>
