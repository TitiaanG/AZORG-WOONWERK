
<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Rij-afstand (auto & fiets) naar 6 adressen</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; max-width: 980px; margin: 2rem auto; padding: 0 1rem; }
  h1 { font-size: 1.4rem; }
  .row { display: flex; gap: 0.8rem; margin: 0.6rem 0; }
  input[type=text], input[type=password] { flex: 1; padding: 0.6rem; font-size: 1rem; }
  button { padding: 0.6rem 1rem; font-size: 1rem; cursor: pointer; }
  small { color: #555; }
  table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
  th, td { border: 1px solid #ddd; padding: .6rem; text-align: left; vertical-align: top; }
  th { background: #f7f7f7; }
  .muted { color: #666; }
  .error { color: #b00020; }
  .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid #999; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<h1>Rij-afstand (hem via weg) en reistijd — auto & fiets</h1>

<div class="row">
  <label for="apiKey" style="min-width: 140px;">ORS API key:</label>
  <input id="apiKey" type="password" placeholder="Plak hier je ORS API sleutel" value="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImY0YTA5MTgyZWRjODRiNTZhMzI5ZWY3ZDJiZTNhYTQ3IiwiaCI6Im11cm11cjY0In0="/>
</div>

<div class="row">
  <label for="userAddress" style="min-width: 140px;">Je adres:</label>
  <input id="userAddress" type="text" placeholder="Straat Huisnummer, Stad, Land (bv. Merestraat 80, Aalst, België)"/>
</div>

<div class="row">
  <button id="calcBtn">Bereken</button>
  <small class="muted">Profielen: auto = <code>driving-car</code>, fiets = <code>cycling-regular</code></small>
</div>

<div id="status" class="muted"></div>
<div id="error" class="error"></div>

<table id="results" style="display:none;">
  <thead>
    <tr>
      <th>#</th>
      <th>Referentie-adres</th>
      <th>Auto — afstand / tijd</th>
      <th>Fiets — afstand / tijd</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
/** ============ CONFIG: jouw 6 adressen ============ */
const REF_ADDRESSES = [
  "Merestraat 80, 9300 Aalst",
  "Moorselbaan 184, 9300 Aalst",
  "Bloklaan 5, 1730 Asse",
  "Gasthuisstraat 4, 9500 Geraardsbergen",
  "Biezenstraat 2, 9400 Ninove",
  "Wegvoeringstraat 73, 9230 Wetteren",
];

// Je kunt boundary.country=BE zetten om te biasen naar België
const GEOCODE_LANG = "nl"; // resultaat labels in NL indien mogelijk
const COUNTRY_BIAS = "BE";

/** ============ Helpers ============ */
const sleep = (ms) => new Promise(res => setTimeout(res, ms));
function fmtKm(meters) {
  if (meters == null || !isFinite(meters)) return "—";
  return (meters/1000).toFixed(2) + " km";
}
function fmtDuration(seconds) {
  if (seconds == null || !isFinite(seconds)) return "—";
  const s = Math.round(seconds);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  const sec = s % 60;
  if (h > 0) return `${h} u ${m} min`;
  if (m > 0) return `${m} min`;
  return `${sec} s`;
}
function setStatus(msg) {
  const el = document.getElementById('status');
  el.innerHTML = msg ? `<span class="spinner"></span> ${msg}` : "";
}
function setError(msg) {
  document.getElementById('error').textContent = msg || "";
}

/** ============ ORS API calls ============ */
// Geocode (forward) via ORS
async function geocodeORS(address, apiKey) {
  const url = new URL("https://api.openrouteservice.org/geocode/search");
  url.searchParams.set("text", address);
  url.searchParams.set("size", "1");
  if (GEOCODE_LANG) url.searchParams.set("lang", GEOCODE_LANG);
  if (COUNTRY_BIAS) url.searchParams.set("boundary.country", COUNTRY_BIAS);
  const resp = await fetch(url.toString(), {
    headers: { "Authorization": apiKey, "Accept": "application/json" }
  });
  if (!resp.ok) {
    throw new Error(`Geocode fout (${resp.status})`);
  }
  const data = await resp.json();
  if (!data || !data.features || data.features.length === 0) {
    return null;
  }
  const f = data.features[0];
  // GeoJSON: coordinates = [lon, lat]
  return { lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0], label: f.properties.label || address };
}

// Route (driving-car / cycling-regular) via ORS
async function routeORS(profile, start, end, apiKey) {
  const url = `https://api.openrouteservice.org/v2/directions/${profile}`;
  const body = {
    coordinates: [
      [start.lon, start.lat],
      [end.lon, end.lat]
    ],
    units: "km", // samenvatting in km & seconden
    language: GEOCODE_LANG
  };
  const resp = await fetch(url, {
    method: "POST",
    headers: {
      "Authorization": apiKey,
      "Content-Type": "application/json",
      "Accept": "application/json"
    },
    body: JSON.stringify(body)
  });
  if (!resp.ok) {
    throw new Error(`Route fout (${profile}, ${resp.status})`);
  }
  const data = await resp.json();
  const route = data && data.routes && data.routes[0];
  if (!route || !route.summary) {
    throw new Error("Geen route samenvatting ontvangen.");
  }
  return {
    distanceMeters: route.summary.distance * 1000, // units=km → distance in km; converteren naar meters
    durationSeconds: route.summary.duration
  };
}

/** ============ Hoofdlogica ============ */
document.getElementById('calcBtn').addEventListener('click', async () => {
  setError("");
  setStatus("Adres geocoderen…");
  document.getElementById('results').style.display = 'none';
  const tbody = document.querySelector('#results tbody');
  tbody.innerHTML = "";

  const apiKey = document.getElementById('apiKey').value.trim();
  const userAddr = document.getElementById('userAddress').value.trim();

  if (!apiKey) { setError("Vul eerst je ORS API key in."); return; }
  if (!userAddr) { setError("Vul eerst je adres in."); return; }

  try {
    // Geocode bronadres
    const origin = await geocodeORS(userAddr, apiKey);
    if (!origin) { setError("Je adres kon niet worden gevonden. Voeg stad/land toe en controleer spelling."); return; }

    // Geocodeer alle referenties (cache)
    setStatus("Referentie-adressen geocoderen…");
    const refs = [];
    for (let i=0; i<REF_ADDRESSES.length; i++) {
      await sleep(250); // beleefd kleine delay
      const addr = REF_ADDRESSES[i];
      const r = await geocodeORS(addr, apiKey);
      if (!r) {
        refs.push({ addr, lat: null, lon: null, label: addr, geocodeOk: false });
      } else {
        refs.push({ addr, lat: r.lat, lon: r.lon, label: r.label, geocodeOk: true });
      }
    }

    // Routes berekenen (auto & fiets)
    setStatus("Routes berekenen (auto & fiets)…");
    const results = [];
    for (let i=0; i<refs.length; i++) {
      const ref = refs[i];
      if (!ref.geocodeOk) {
        results.push({
          idx: i+1, addr: ref.addr,
          car: {distanceMeters: NaN, durationSeconds: NaN},
          bike: {distanceMeters: NaN, durationSeconds: NaN}
        });
        continue;
      }
      await sleep(250);
      const car = await routeORS("driving-car", origin, ref, apiKey);
      await sleep(250);
      const bike = await routeORS("cycling-regular", origin, ref, apiKey);

      results.push({
        idx: i+1, addr: ref.addr,
        car, bike
      });
    }

    // Sorteer op auto-afstand (optioneel)
    results.sort((a,b) => (a.car.distanceMeters||Infinity) - (b.car.distanceMeters||Infinity));

    // Tabel vullen
    for (const r of results) {
      const tr = document.createElement('tr');
      const carTxt = `${fmtKm(r.car.distanceMeters)} / ${fmtDuration(r.car.durationSeconds)}`;
      const bikeTxt = `${fmtKm(r.bike.distanceMeters)} / ${fmtDuration(r.bike.durationSeconds)}`;
      tr.innerHTML = `
        <td>${r.idx}</td>
        <td>${r.addr}</td>
        <td>${carTxt}</td>
        <td>${bikeTxt}</td>
      `;
      tbody.appendChild(tr);
    }

    setStatus("");
    document.getElementById('results').style.display = 'table';
  } catch (e) {
    setStatus("");
    setError("Er ging iets mis: " + e.message);
    console.error(e);
  }
});
</script>
</body>
</html>
