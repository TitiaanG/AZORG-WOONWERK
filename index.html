
<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AZORG-WOONWERK — Woon-werkverkeer calculator (6 campussen)</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
  h1 { font-size: 1.6rem; margin-bottom: .2rem; }
  .subtitle { color: #555; margin-bottom: 1rem; }
  .row { display: flex; gap: 0.8rem; margin: 0.6rem 0; align-items: center; flex-wrap: wrap; }
  label { min-width: 180px; }
  input[type=text], input[type=password] { flex: 1; min-width: 280px; padding: 0.6rem; font-size: 1rem; }
  button { padding: 0.6rem 1rem; font-size: 1rem; cursor: pointer; }
  table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
  th, td { border: 1px solid #ddd; padding: .6rem; text-align: left; vertical-align: top; }
  th { background: #f7f7f7; }
  .muted { color: #666; }
  .error { color: #b00020; margin-top: .4rem; white-space: pre-line; }
  .spinner { display: inline-block; width: 1em; height: 1em; border: 2px solid #999; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .rates { margin-top: .6rem; font-size: .95rem; color: #333; }
  .rates code { background: #f4f4f4; padding: .1rem .3rem; border-radius: .2rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<h1>AZORG-WOONWERK</h1>
<div class="subtitle">Woon-werkverkeer calculator voor 6 campussen</div>

<div class="row">
  <label for="apiKey">OpenRouteService API-key:</label>
  <!-- ✅ API-key vooraf ingevuld; we lezen hem uit dit veld -->
  <input id="apiKey" type="password"
         value="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImY0YTA5MTgyZWRjODRiNTZhMzI5ZWY3ZDJiZTNhYTQ3IiwiaCI6Im11cm11cjY0In0="
         placeholder="Plak hier je ORS API sleutel"/>
</div>

<div class="row">
  <label for="userAddress">Je vertrekadres:</label>
  <input id="userAddress" type="text" placeholder="Straat Huisnummer, Stad, Land (bv. Korenmarkt 1, Aalst, België)"/>
  <button id="calcBtn">Bereken</button>
</div>

<div class="rates">
  <strong>Tarieven woon‑werkvergoeding:</strong>
  <ul>
    <li>Wagen (vanaf <em>4 km</em>, enkel heen): <code>€ 0,4449/km</code></li>
    <li>Fiets (alle km, <strong>heen + terug</strong>): <code>€ 0,3600/km</code></li>
  </ul>
</div>

<div id="status" class="muted"></div>
<div id="error" class="error"></div>

<table id="results" style="display:none;">
  <thead>
    <tr>
      <th>#</th>
      <th>Campus</th>
      <th>Auto — afstand / tijd</th>
      <th>Fiets — afstand / tijd</th>
      <th>Vergoeding auto</th>
      <th>Vergoeding fiets <span class="muted">(heen + terug)</span></th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
/** ============ Campussen (label + adres) ============ */
const REF_CAMPUSES = [
  { label: "Moorselbaan: Campus Moorselbaan",    addr: "Moorselbaan 184, 9300 Aalst" },
  { label: "Merestraat: Campus Merestraat",      addr: "Merestraat 80, 9300 Aalst" },
  { label: "Wetteren: Campus Wetteren",          addr: "Wegvoeringstraat 73, 9230 Wetteren" },
  { label: "Ninove: Campus Ninove",              addr: "Biezenstraat 2, 9400 Ninove" },
  { label: "Asse: Campus Asse",                  addr: "Bloklaan 5, 1730 Asse" },
  { label: "Geraardsbergen: Campus Geraardsbergen", addr: "Gasthuisstraat 4, 9500 Geraardsbergen" },
];

/** ============ Vergoedingsparameters ============ */
const CAR_RATE_EUR_PER_KM   = 0.4449; // auto: € 0,4449/km
const BIKE_RATE_EUR_PER_KM  = 0.3600; // fiets: € 0,3600/km
const CAR_MIN_KM            = 4;      // auto: enkel vanaf 4 km (heen)
const BIKE_ROUND_TRIP_MULT  = 2;      // fiets: heen + terug

/** ============ Helpers ============ */
const sleep = (ms) => new Promise(res => setTimeout(res, ms));
function fmtKm(meters) { return (meters==null||!isFinite(meters)) ? "—" : (meters/1000).toFixed(2) + " km"; }
function fmtDuration(seconds) {
  if (seconds==null || !isFinite(seconds)) return "—";
  const s = Math.round(seconds), h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  if (h>0) return `${h} u ${m} min`; if (m>0) return `${m} min`; return `${sec} s`;
}
const fmtCurrency = new Intl.NumberFormat('nl-BE', { style: 'currency', currency: 'EUR', minimumFractionDigits: 2, maximumFractionDigits: 4 });

function calcCarAllowance(distanceMeters) {
  if (distanceMeters==null || !isFinite(distanceMeters)) return 0;
  const km = distanceMeters / 1000;
  if (km < CAR_MIN_KM) return 0;                 // geen vergoeding onder 4 km
  return km * CAR_RATE_EUR_PER_KM;               // enkel heen
}
function calcBikeAllowance(distanceMeters) {
  if (distanceMeters==null || !isFinite(distanceMeters)) return 0;
  const km = distanceMeters / 1000;
  // ✅ heen + terug
  return km * BIKE_RATE_EUR_PER_KM * BIKE_ROUND_TRIP_MULT;
}

/** ============ ORS (GET met api_key in query) ============ */
async function geocodeORS(address, apiKey) {
  const url = new URL("https://api.openrouteservice.org/geocode/search");
  url.searchParams.set("api_key", apiKey);
  url.searchParams.set("text", address);
  url.searchParams.set("size", "1");
  url.searchParams.set("lang", "nl");
  url.searchParams.set("boundary.country", "BE");
  const resp = await fetch(url.toString(), { headers: { "Accept": "application/json" }});
  if (!resp.ok) throw new Error(`Geocode fout (${resp.status})`);
  const data = await resp.json();
  if (!data.features || data.features.length===0) return null;
  const f = data.features[0];
  return { lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0], label: f.properties.label || address };
}

async function directionsORS_GET(profile, start, end, apiKey) {
  const base = `https://api.openrouteservice.org/v2/directions/${profile}`;
  const url = new URL(base);
  url.searchParams.set("api_key", apiKey);
  url.searchParams.set("start", `${start.lon},${start.lat}`);
  url.searchParams.set("end",   `${end.lon},${end.lat}`);
  url.searchParams.set("units", "km");
  const resp = await fetch(url.toString(), { headers: { "Accept": "application/json" }});
  if (!resp.ok) throw new Error(`Route fout (${profile}, ${resp.status})`);
  const data = await resp.json();
  const route = data?.routes?.[0];
  if (!route?.summary) throw new Error("Geen route samenvatting ontvangen.");
  return { distanceMeters: route.summary.distance*1000, durationSeconds: route.summary.duration };
}

/** ============ Hoofdlogica ============ */
document.getElementById('calcBtn').addEventListener('click', async () => {
  const statusEl = document.getElementById('status');
  const errorEl = document.getElementById('error');
  const tbody = document.querySelector('#results tbody');
  errorEl.textContent = ""; statusEl.innerHTML = `<span class="spinner"></span> Adres geocoderen…`;
  document.getElementById('results').style.display = 'none'; tbody.innerHTML = "";

  const apiKey = document.getElementById('apiKey').value.trim();
  const userAddr = document.getElementById('userAddress').value.trim();
  if (!apiKey) { errorEl.textContent = "Vul eerst je ORS API key in."; return; }
  if (!userAddr) { errorEl.textContent = "Vul eerst je vertrekadres in."; return; }

  try {
    // 1) Geocode herkomst (1 call)
    const origin = await geocodeORS(userAddr, apiKey);
    if (!origin) { errorEl.textContent = "Je adres kon niet worden gevonden. Voeg stad/land toe en controleer spelling."; return; }

    // 2) Geocode alle campussen één keer
    statusEl.innerHTML = `<span class="spinner"></span> Campussen geocoderen…`;
    const dests = [];
    for (const c of REF_CAMPUSES) {
      await sleep(300);
      const g = await geocodeORS(c.addr, apiKey);
      dests.push(g ? { label:c.label, addr:c.addr, ok:true, lat:g.lat, lon:g.lon }
                   : { label:c.label, addr:c.addr, ok:false });
    }

    // 3) Routes berekenen (GET) met kleine delay
    statusEl.innerHTML = `<span class="spinner"></span> Routes berekenen…`;
    const results = [];
    for (let i=0; i<dests.length; i++) {
      const d = dests[i];
      if (!d.ok) {
        results.push({ idx:i+1, label:d.label,
          car:{distanceMeters:NaN,durationSeconds:NaN},
          bike:{distanceMeters:NaN,durationSeconds:NaN},
          carAllowance:0, bikeAllowance:0
        });
        continue;
      }
      const end = { lat:d.lat, lon:d.lon };
      await sleep(300);
      const car  = await directionsORS_GET("driving-car", origin, end, apiKey);
      await sleep(300);
      const bike = await directionsORS_GET("cycling-regular", origin, end, apiKey);

      const carAllowance  = calcCarAllowance(car.distanceMeters);
      const bikeAllowance = calcBikeAllowance(bike.distanceMeters); // ✅ heen+terug
      results.push({ idx:i+1, label:d.label, car, bike, carAllowance, bikeAllowance });
    }

    // 4) Sorteer op auto-afstand
    results.sort((a,b) => (a.car.distanceMeters||Infinity) - (b.car.distanceMeters||Infinity));

    // 5) Tabel vullen (gebruik campuslabel i.p.v. adres)
    for (const r of results) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.idx}</td>
        <td>${r.label}</td>
        <td>${fmtKm(r.car.distanceMeters)} / ${fmtDuration(r.car.durationSeconds)}</td>
        <td>${fmtKm(r.bike.distanceMeters)} / ${fmtDuration(r.bike.durationSeconds)}</td>
        <td>${fmtCurrency.format(r.carAllowance)}</td>
        <td>${fmtCurrency.format(r.bikeAllowance)}</td>
      `;
      tbody.appendChild(tr);
    }

    document.getElementById('results').style.display = 'table';
    statusEl.textContent = "";
  } catch(e) {
    statusEl.textContent = "";
    errorEl.textContent =
      "Er ging iets mis: " + (e?.message || e) +
      "\nTip: Geef een volledig adres (straat + nr + stad + land) en probeer desnoods incognito of met harde refresh.";
    console.error(e);
  }
});
</script>
</body>
</html>
